name: Deploy to Dokku (via VPN)

on:
  push:
    paths:
      - 'deployment-manifest.yaml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2   # needed so we can diff against previous commit

      - name: Extract updated services from manifest
        id: manifest
        run: |
          # Get changed services by diffing manifest
          CHANGED_SERVICES=$(git diff HEAD^ HEAD -- deployment-manifest.yaml | \
            grep '^[+-]  ' | grep -v '^[+-]  services:' | sed -E 's/^[+-]  "?(.*)"?:.*/\1/' | sort -u)

          echo "CHANGED_SERVICES=$CHANGED_SERVICES" >> $GITHUB_ENV

          echo "üîç Services changed in manifest:"
          echo "$CHANGED_SERVICES"

      - name: VPN Connect & Deploy updated services
        if: env.CHANGED_SERVICES != ''
        uses: igdevx/vpn-connect@v0.4
        with:
          vpn_gateway: ${{ secrets.VPN_GATEWAY }}
          vpn_psk: ${{ secrets.VPN_PSK }}
          vpn_username: ${{ secrets.VPN_USERNAME }}
          vpn_password: ${{ secrets.VPN_PASSWORD }}
          vpn_nt_domain: ${{ secrets.VPN_NT_DOMAIN }}
          run_command: |
            echo "üîπ Redeploying updated services only..."

            mkdir -p ~/.ssh
            cat <<EOF > ~/.ssh/id_rsa
            ${{ secrets.DOKKU_SSH_KEY }}
            EOF
            chmod 600 ~/.ssh/dokku
            eval "$(ssh-agent -s)"
            ssh-add ~/.ssh/dokku
            ssh-keyscan -H "${{ secrets.DOKKU_HOST }}" >> ~/.ssh/known_hosts

            for service in $CHANGED_SERVICES; do
              IMAGE=$(yq -r ".services.\"$service\"" deployment-manifest.yaml)
              echo "Deploying $service with image $IMAGE"

              ssh dokku@${{ secrets.DOKKU_HOST }} git:from-image $service $IMAGE
            done

            echo "‚úÖ Updated services deployed!"

